import{r as v,d as T,D as B,o as h,e as f}from"./index-CCRf4Tvv.js";const g={url:"",heartBeatData:"",heartBeatInterval:10*1e3,reconnectInterval:5*1e3,maxReconnectAttempts:10,receiveFun:null},A=c=>{const e={options:{...g,...c},socket:null,heartBetaSendTimer:null,heartBetaTimeoutTimer:null,reconnectAttempts:0,reconnectTimeout:null},o=v("连接已断开"),n=1e3,s=v(),a=()=>{r(),o.value="正在连接...",e.socket=new WebSocket(e.options.url),e.socket.onopen=t=>{console.log("socket连接:",t),o.value="连接已建立",e.reconnectAttempts=0,l()},e.socket.onmessage=t=>{l(),console.log("socket消息:",t),e.options.receiveFun&&e.options.receiveFun(t.data),s.value=t.data},e.socket.onclose=t=>{console.log("socket关闭:",t),o.value="连接已断开",t.code!==n&&m()},e.socket.onerror=t=>{console.log("socket报错:",t),o.value="连接已断开",m()}},d=t=>{var k;o.value==="连接已建立"&&((k=e.socket)==null||k.send(t))},r=()=>{p(),e.socket&&(e.socket.OPEN||e.socket.CONNECTING)&&(console.log("socket断开连接"),o.value="连接正在关闭",e.socket.onmessage=null,e.socket.onerror=null,e.socket.onclose=null,e.socket.close(n,"normal closure"),o.value="连接已断开",e.socket=null)},l=()=>{u(()=>{var t;o.value==="连接已建立"&&((t=e.socket)==null||t.send(e.options.heartBeatData),console.log("socket心跳发送:",e.options.heartBeatData))})},u=t=>{e.heartBetaSendTimer=setTimeout(()=>{t&&t(),i(),u(t)},e.options.heartBeatInterval)},i=()=>{e.heartBetaSendTimer&&clearTimeout(e.heartBetaSendTimer)},m=()=>{if(!(o.value==="连接已建立"||o.value==="正在连接..."))if(i(),e.reconnectAttempts<e.options.maxReconnectAttempts){console.log("socket重连:",e.reconnectAttempts);const t=Math.max(e.options.reconnectInterval,e.reconnectAttempts*1e3);console.log("间隔时间：",t),e.reconnectTimeout=setTimeout(()=>{o.value!=="连接已建立"&&o.value!=="正在连接..."&&a()},t),e.reconnectAttempts+=1}else o.value="连接已断开",p()},p=()=>{e.reconnectTimeout&&clearTimeout(e.reconnectTimeout)};return{message:s,connect:a,onSend:d,disconnect:r}},S=T({__name:"im",setup(c){const e=A({url:"ws://localhost:3000"});return B(()=>{e.connect()}),(o,n)=>(h(),f("div",null,"1231"))}});export{S as default};
